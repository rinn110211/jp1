<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>記帳助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8FAFC;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .tab-content {
            display: none;
            animation: cardSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes cardSlideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-btn {
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-btn.active {
            color: #2563eb;
            transform: scale(1.1) translateY(-6px);
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            width: 0;
            height: 3px;
            background: #2563eb;
            border-radius: 99px;
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }

        .nav-btn.active::after {
            width: 14px;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dynamic-card {
            transition: all 0.2s ease;
        }

        .dynamic-card:active {
            transform: scale(0.97);
        }

        .floating-nav {
            bottom: 20px;
            left: 10px;
            right: 10px;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .income-text { color: #059669; }
        .expense-text { color: #334155; }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="max-w-md mx-auto flex flex-col bg-slate-50 border-x border-slate-100 shadow-2xl">

    <!-- Header -->
    <header class="glass-effect sticky top-0 z-40 p-3 flex justify-between items-center px-6">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-1.5 rounded-xl text-white shadow-md shadow-blue-100">
                <i data-lucide="japanese-yen" size="18" stroke-width="3"></i>
            </div>
        </div>
        <button onclick="toggleSettings(true)" class="p-2 text-slate-400 bg-white rounded-xl border border-slate-100 shadow-sm active:scale-90 transition-all">
            <i data-lucide="settings" size="20"></i>
        </button>
    </header>

    <!-- 主內容區 -->
    <main id="scroll-area" class="flex-1 overflow-y-auto scrollbar-hide px-4 pt-3 pb-44">
        
        <!-- Dashboard Tab -->
        <section id="tab-dashboard" class="tab-content active space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-black text-slate-800 tracking-tight">資產概覽</h2>
                <div class="bg-white border border-slate-100 px-2 py-1 rounded-xl shadow-sm">
                    <input type="month" id="dash-month-input" onchange="changeDashboardMonth(this.value)" class="text-[10px] font-bold text-blue-600 border-none bg-transparent outline-none cursor-pointer">
                </div>
            </div>

            <!-- 資產餘額卡片 -->
            <div class="bg-white rounded-[2rem] p-6 border border-blue-50 shadow-[0_12px_35px_rgba(37,99,235,0.06)] relative overflow-hidden group dynamic-card">
                <div class="absolute -top-6 -right-6 p-4 text-blue-100 opacity-20 rotate-12 transition-transform duration-1000">
                    <i data-lucide="wallet" size="120"></i>
                </div>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest relative z-10 opacity-70">預估剩餘總資產</p>
                <h2 id="dash-total-assets" class="text-3xl font-black mt-1 text-slate-800 tracking-tighter relative z-10">¥0</h2>
                <div class="mt-4 flex justify-between items-center relative z-10">
                    <span id="dash-total-twd" class="font-black text-blue-600 bg-blue-50 px-3 py-1.5 rounded-xl text-xs">≈ NT$ 0</span>
                    <span id="dash-rate" class="text-[9px] font-bold text-slate-300">1 JPY = 0.215 TWD</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100 shadow-sm text-center dynamic-card">
                    <p class="text-xs text-emerald-600 font-bold uppercase mb-0.5">該月收入</p>
                    <p id="dash-month-income" class="font-black text-lg text-emerald-700">¥0</p>
                </div>
                <div class="bg-slate-100/50 p-4 rounded-2xl border border-slate-200 shadow-sm text-center dynamic-card">
                    <p class="text-xs text-slate-500 font-bold uppercase mb-0.5">該月支出</p>
                    <p id="dash-month-expense" class="font-black text-lg text-slate-800">¥0</p>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest text-center">支出類別分布</h3>
                <div class="relative h-48 w-full flex justify-center">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div id="chart-legend-empty" class="hidden text-center py-4 text-slate-300 text-xs font-bold italic">該月份目前無支出數據</div>
            </div>
        </section>

        <!-- Add Tab -->
        <section id="tab-add" class="tab-content space-y-5">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800 text-sm">新增紀錄</h2>
                <div class="bg-slate-200/50 p-1 rounded-xl flex gap-1 shadow-inner">
                    <button onclick="setInputCurrency('JPY')" id="btn-jpy" class="px-3 py-1.5 rounded-lg text-xs font-black transition-all bg-white text-blue-600 shadow-sm">JPY</button>
                    <button onclick="setInputCurrency('TWD')" id="btn-twd" class="px-3 py-1.5 rounded-lg text-xs font-black transition-all text-slate-500">TWD</button>
                </div>
            </div>

            <div class="grid grid-cols-2 bg-slate-200/50 p-1 rounded-[18px] shadow-inner">
                <button onclick="setInputType('expense')" id="btn-type-expense" class="py-2.5 rounded-2xl text-xs font-black transition-all bg-white text-slate-700 shadow-sm flex items-center justify-center gap-1.5">
                    <i data-lucide="arrow-down-right" size="14"></i> 支出
                </button>
                <button onclick="setInputType('income')" id="btn-type-income" class="py-2.5 rounded-2xl text-xs font-black transition-all text-slate-500 flex items-center justify-center gap-1.5">
                    <i data-lucide="arrow-up-right" size="14"></i> 收入
                </button>
            </div>

            <form onsubmit="saveTransaction(event)" class="space-y-4">
                <div class="bg-white p-5 rounded-2xl shadow-lg border border-blue-50 relative overflow-hidden">
                    <div id="input-bg-accent" class="absolute top-0 right-0 w-16 h-16 bg-slate-100 rounded-full -mr-8 -mt-8 transition-all duration-700"></div>
                    <label id="input-label" class="text-xs font-bold text-slate-400 uppercase tracking-widest relative z-10">金額紀錄</label>
                    <div class="flex items-center mt-1 border-b border-slate-100 pb-1 focus-within:border-blue-500 relative z-10 transition-colors">
                        <span id="currency-symbol" class="text-xl font-black text-slate-300">¥</span>
                        <input type="number" step="any" id="input-amount" class="w-full bg-transparent border-none text-3xl font-black focus:ring-0 ml-1 text-slate-800 outline-none" placeholder="0">
                    </div>
                    <p id="conversion-hint" class="mt-2 text-xs font-bold text-blue-400 hidden flex items-center gap-1 relative z-10"></p>
                </div>

                <div class="flex gap-2">
                    <div class="flex-1 bg-white p-0.5 rounded-xl border border-slate-100 shadow-sm">
                        <input type="date" id="input-date" class="w-full bg-transparent p-2.5 text-xs font-black outline-none text-slate-600">
                    </div>
                    <div class="flex-[1.5] bg-white p-0.5 rounded-xl border border-slate-100 shadow-sm">
                        <input type="text" id="input-note" placeholder="寫點備註..." class="w-full bg-transparent p-2.5 text-xs font-black outline-none text-slate-600">
                    </div>
                </div>

                <div class="space-y-2">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">分類</p>
                    <div class="grid grid-cols-4 gap-2" id="add-category-grid"></div>
                </div>

                <div class="space-y-2">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">支付管道</p>
                    <div class="grid grid-cols-3 gap-2" id="add-payment-grid"></div>
                </div>

                <button type="submit" id="save-btn" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm">
                    <i data-lucide="check" size="18"></i> 確認存入帳本
                </button>
            </form>
        </section>

        <!-- History Tab -->
        <section id="tab-history" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800 text-sm">歷史明細</h2>
                <div class="flex bg-slate-200/50 p-1 rounded-xl shadow-inner" id="history-filter">
                    <button onclick="setFilter('day')" id="filter-day" class="px-3 py-1 rounded-lg text-xs font-black uppercase transition-all text-slate-500">本日</button>
                    <button onclick="setFilter('month')" id="filter-month" class="px-3 py-1 rounded-lg text-xs font-black uppercase transition-all bg-white text-blue-600 shadow-sm">本月</button>
                    <button onclick="setFilter('all')" id="filter-all" class="px-3 py-1 rounded-lg text-xs font-black uppercase transition-all text-slate-500">全部</button>
                </div>
            </div>

            <div class="glass-effect p-3 px-4 rounded-2xl flex items-center justify-between shadow-sm">
                <span id="date-selector-label" class="text-xs font-black text-slate-400 uppercase">篩選範圍</span>
                <div id="date-input-wrapper" class="font-bold text-blue-600 text-sm"></div>
            </div>

            <div class="bg-white p-5 rounded-[1.8rem] border border-slate-100 shadow-sm space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">區間收入合計</span>
                    <span id="history-period-income" class="text-emerald-600 font-black text-sm">¥0</span>
                </div>
                <div class="flex justify-between items-center border-t border-slate-50 pt-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">區間支出合計</span>
                    <span id="history-period-expense" class="text-slate-700 font-black text-sm">¥0</span>
                </div>
                <div class="flex justify-between items-center border-t-2 border-blue-50 pt-2 mt-1">
                    <span class="text-xs font-black text-slate-800 uppercase">區間總損益</span>
                    <span id="history-period-balance" class="text-blue-600 font-black text-lg">¥0</span>
                </div>
            </div>

            <div id="history-list" class="space-y-2.5 pb-20"></div>
        </section>

        <!-- Accounts Tab (New) -->
        <section id="tab-accounts" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800 text-sm">帳戶資產</h2>
                <div class="bg-white px-3 py-1.5 rounded-xl border border-slate-100 shadow-sm">
                    <span class="text-[10px] font-black text-slate-400 uppercase">統計帳戶數：</span>
                    <span id="account-count" class="text-xs font-black text-blue-600">0</span>
                </div>
            </div>
            <div id="accounts-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- Initial Costs Tab -->
        <section id="tab-initial" class="tab-content space-y-4">
            <div class="bg-white rounded-[1.8rem] p-5 border border-blue-50 shadow-sm relative overflow-hidden dynamic-card">
                <div class="absolute -top-4 -right-4 p-4 text-blue-50 opacity-30 rotate-12"><i data-lucide="plane" size="80"></i></div>
                <div class="grid grid-cols-2 gap-4 mb-2 relative z-10">
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest leading-none">實際總開銷</p>
                        <h2 id="init-total-display" class="text-2xl font-black text-slate-800 mt-1">¥0</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest leading-none">項目預算合計</p>
                        <h2 id="init-budget-sum-display" class="text-xl font-black text-slate-500 mt-1">¥0</h2>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-1 relative z-10 border-t border-slate-50 pt-2">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">剩餘可用預算</p>
                    <h2 id="init-rem-display" class="text-lg font-black text-blue-600">¥0</h2>
                </div>
                
                <div class="mt-3 relative h-1.5 bg-slate-100 rounded-full overflow-hidden z-10">
                    <div id="init-progress-bar" class="h-full bg-blue-600 transition-all duration-1000 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-1.5 text-xs font-black uppercase text-slate-400 relative z-10">
                    <span>進度</span>
                    <span id="init-progress-text" class="text-blue-600 font-bold">0%</span>
                </div>
            </div>

            <div class="bg-white p-3.5 rounded-2xl border border-blue-100 shadow-sm flex items-center justify-between">
                <div>
                    <h4 class="text-xs font-black text-blue-500 uppercase tracking-widest">初期總預算上限設定</h4>
                    <div class="flex items-center gap-1 mt-0.5">
                        <span class="text-sm font-black text-slate-700">¥</span>
                        <input type="number" id="init-budget-input" oninput="updateInitialBudget(this.value)" class="w-16 bg-slate-50 border-none rounded-lg p-1 text-sm font-black text-blue-600 outline-none" placeholder="0">
                        <span class="text-xs font-bold text-slate-400">萬</span>
                    </div>
                </div>
                <div class="bg-blue-50 p-1.5 rounded-lg text-blue-600"><i data-lucide="target" size="16"></i></div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-md space-y-3">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">新增初期大型支出</h3>
                <form onsubmit="saveInitialCost(event)" class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="init-input-name" placeholder="項目" class="w-full bg-slate-50 border-none rounded-lg p-2.5 text-xs font-black outline-none focus:ring-1 focus:ring-blue-100 transition-all">
                        <input type="text" id="init-input-note" placeholder="詳細備註" class="w-full bg-slate-50 border-none rounded-lg p-2.5 text-xs font-black outline-none focus:ring-1 focus:ring-blue-100 transition-all">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 flex items-center bg-slate-50 rounded-lg px-2 border border-slate-100">
                            <span class="text-[10px] font-bold text-slate-400 mr-1 shrink-0">預算</span>
                            <input type="number" id="init-input-budget" placeholder="¥" class="w-full bg-transparent p-1.5 text-sm font-black outline-none">
                        </div>
                        <div class="flex-1 flex items-center bg-slate-50 rounded-lg px-2 border border-slate-100">
                            <span class="text-[10px] font-bold text-slate-400 mr-1 shrink-0">實際</span>
                            <input type="number" id="init-input-actual" placeholder="¥" class="w-full bg-transparent p-1.5 text-sm font-black outline-none">
                        </div>
                        <button type="submit" class="bg-slate-900 text-white px-4 rounded-lg font-black shadow-lg active:scale-90 transition-all">
                            <i data-lucide="plus" size="16"></i>
                        </button>
                    </div>
                </form>
            </div>
            <div id="initial-costs-list" class="space-y-2 pb-24"></div>
        </section>
    </main>

    <!-- 導覽列 -->
    <nav class="floating-nav glass-effect fixed max-w-md mx-auto py-3 px-4 flex justify-around items-center z-40">
        <button onclick="switchTab('add')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="add">
            <i data-lucide="plus-circle" size="20"></i>
            <span class="text-[9px] font-black tracking-widest uppercase">新增</span>
        </button>
        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="history">
            <i data-lucide="list" size="20"></i>
            <span class="text-[9px] font-black tracking-widest uppercase">明細</span>
        </button>
        <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center gap-1 text-slate-300 active" data-tab="dashboard">
            <i data-lucide="layout-dashboard" size="20"></i>
            <span class="text-[9px] font-black tracking-widest uppercase">總覽</span>
        </button>
        <button onclick="switchTab('accounts')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="accounts">
            <i data-lucide="wallet" size="20"></i>
            <span class="text-[9px] font-black tracking-widest uppercase">帳戶</span>
        </button>
        <button onclick="switchTab('initial')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="initial">
            <i data-lucide="calculator" size="20"></i>
            <span class="text-[9px] font-black tracking-widest uppercase">初期</span>
        </button>
    </nav>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6 modal-backdrop">
        <div class="bg-white w-full max-w-sm rounded-[2.2rem] p-7 shadow-2xl relative animate-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-black text-slate-800">資料與備份管理</h2>
                <button onclick="toggleSettings(false)" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" size="18"></i></button>
            </div>
            
            <div class="space-y-5 max-h-[60vh] overflow-y-auto scrollbar-hide pr-1">
                <section class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                    <h3 class="text-xs font-black text-blue-600 uppercase tracking-widest mb-3">資料備份與還原</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportData()" class="flex flex-col items-center gap-1.5 p-3 bg-white rounded-xl border border-blue-100 shadow-sm active:scale-95 transition-all">
                            <i data-lucide="download" size="18" class="text-blue-600"></i>
                            <span class="text-xs font-bold text-slate-600">匯出備份檔</span>
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex flex-col items-center gap-1.5 p-3 bg-white rounded-xl border border-blue-100 shadow-sm active:scale-95 transition-all">
                            <i data-lucide="upload" size="18" class="text-blue-600"></i>
                            <span class="text-xs font-bold text-slate-600">匯入備份檔</span>
                        </button>
                    </div>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                </section>

                <section>
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 px-1">匯率設定</h3>
                    <div class="bg-blue-50 p-3.5 rounded-2xl flex justify-between items-center shadow-inner border border-blue-100">
                        <span class="text-sm font-black text-blue-600">1 JPY =</span>
                        <input type="number" step="0.001" id="set-rate" oninput="updateRate(this.value)" class="w-20 bg-white border-none rounded-xl p-2 text-right font-black text-blue-600 outline-none shadow-sm">
                    </div>
                </section>
                <section>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">支出分類</h3>
                        <button onclick="addItem('cat')" class="text-xs font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">新增</button>
                    </div>
                    <div id="settings-cat-list" class="space-y-1.5"></div>
                </section>
                <section>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">收入分類</h3>
                        <button onclick="addItem('inc')" class="text-xs font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">新增</button>
                    </div>
                    <div id="settings-inc-list" class="space-y-1.5"></div>
                </section>
                <section>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">支付帳戶</h3>
                        <button onclick="addItem('pay')" class="text-xs font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">新增</button>
                    </div>
                    <div id="settings-pay-list" class="space-y-1.5"></div>
                </section>
                <button onclick="confirmResetApp()" class="w-full text-red-400 text-xs font-black py-4 bg-red-50 rounded-2xl tracking-widest uppercase hover:bg-red-100 transition-colors mt-4">清除所有資料</button>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="modal-confirm" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 modal-backdrop">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl text-center animate-in zoom-in duration-200">
            <div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-triangle" size="24"></i></div>
            <h3 id="confirm-title" class="text-base font-black text-slate-800 mb-1">確定執行？</h3>
            <p id="confirm-msg" class="text-xs font-bold text-slate-400 mb-6">此動作執行後將無法還原。</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirm()" class="py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs">取消</button>
                <button id="confirm-execute" class="py-3 bg-slate-900 text-white font-black rounded-xl text-xs">確定</button>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="modal-edit" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-7 shadow-2xl animate-in zoom-in duration-200">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-base font-black text-slate-800 px-2">編輯項目</h3>
                <button onclick="closeEditModal()" class="p-2 bg-slate-50 rounded-full text-slate-400"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="space-y-6">
                <input id="edit-name" type="text" class="w-full bg-slate-50 border-none rounded-2xl p-4 font-black outline-none shadow-inner text-slate-700 text-sm" placeholder="名稱">
                <div id="edit-icon-grid" class="grid grid-cols-5 gap-2.5 max-h-40 overflow-y-auto bg-slate-50 rounded-[1.8rem] p-4 scrollbar-hide border border-slate-100"></div>
                <button onclick="saveItemEdit()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all text-sm">確認儲存</button>
            </div>
        </div>
    </div>

    <!-- Transaction Edit Modal -->
    <div id="modal-transaction-edit" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-7 shadow-2xl animate-in zoom-in duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-black text-slate-800 px-2">編輯紀錄</h3>
                <button onclick="closeTransactionEditModal()" class="p-2 bg-slate-50 rounded-full text-slate-400"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto scrollbar-hide p-1">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">金額 (日幣)</label>
                    <input type="number" id="edit-trans-amount" class="w-full bg-transparent border-none text-2xl font-black focus:ring-0 text-slate-800 outline-none">
                </div>
                <div class="flex gap-2">
                    <input type="date" id="edit-trans-date" class="flex-1 bg-slate-50 rounded-xl p-2.5 text-xs font-black outline-none border border-slate-100 text-slate-600">
                    <input type="text" id="edit-trans-note" placeholder="備註..." class="flex-1 bg-slate-50 rounded-xl p-2.5 text-xs font-black outline-none border border-slate-100 text-slate-600">
                </div>
                <div class="space-y-1">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">分類</p>
                    <div class="grid grid-cols-4 gap-2" id="edit-trans-cat-grid"></div>
                </div>
                <div class="space-y-1">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">支付管道</p>
                    <div class="grid grid-cols-3 gap-2" id="edit-trans-pay-grid"></div>
                </div>
                <button onclick="saveTransactionEdit()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl active:scale-95 transition-all text-sm mt-4">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Initial Edit Modal -->
    <div id="modal-initial-edit" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-7 shadow-2xl animate-in zoom-in duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-black text-slate-800 px-2">編輯初期開支</h3>
                <button onclick="closeInitialEditModal()" class="p-2 bg-slate-50 rounded-full text-slate-400"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100 space-y-3">
                    <input type="text" id="edit-init-name" class="w-full bg-white border-none rounded-xl p-3 text-sm font-black outline-none shadow-sm">
                    <input type="text" id="edit-init-note" class="w-full bg-white border-none rounded-xl p-3 text-xs font-black outline-none shadow-sm">
                    <div class="flex gap-2">
                        <div class="flex-1 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                            <label class="text-[10px] font-black text-slate-400 block mb-0.5">預算 (¥)</label>
                            <input type="number" id="edit-init-budget" class="w-full bg-transparent border-none text-sm font-black outline-none">
                        </div>
                        <div class="flex-1 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                            <label class="text-[10px] font-black text-slate-400 block mb-0.5">實際 (¥)</label>
                            <input type="number" id="edit-init-actual" class="w-full bg-transparent border-none text-sm font-black outline-none">
                        </div>
                    </div>
                </div>
                <button onclick="saveInitialEdit()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl active:scale-95 transition-all text-sm">更新項目</button>
            </div>
        </div>
    </div>

    <script>
        const ICON_OPTIONS = {
            ShoppingBag: { icon: 'shopping-bag', color: '#10B981' },
            Utensils: { icon: 'utensils', color: '#F59E0B' },
            Train: { icon: 'train', color: '#3B82F6' },
            Home: { icon: 'home', color: '#6366F1' },
            BookOpen: { icon: 'book-open', color: '#8B5CF6' },
            Coffee: { icon: 'coffee', color: '#A855F7' },
            CreditCard: { icon: 'credit-card', color: '#4B5563' },
            Plane: { icon: 'plane', color: '#0EA5E9' },
            Coins: { icon: 'coins', color: '#EAB308' },
            Wallet: { icon: 'wallet', color: '#D946EF' },
            Smartphone: { icon: 'smartphone', color: '#2DD4BF' },
            AlertCircle: { icon: 'alert-circle', color: '#EF4444' },
            Ticket: { icon: 'ticket', color: '#FACC15' },
            Shirt: { icon: 'shirt', color: '#06B6D4' },
            Wifi: { icon: 'wifi', color: '#2563EB' },
            Stethoscope: { icon: 'stethoscope', color: '#06B6D4' },
            Heart: { icon: 'heart', color: '#F43F5E' },
            Construction: { icon: 'construction', color: '#84CC16' }
        };

        const DEFAULTS = {
            categories: [
                { id: 'c1', name: '超市採買', icon: 'ShoppingBag' },
                { id: 'c2', name: '外食餐廳', icon: 'Utensils' },
                { id: 'c3', name: '交通費用', icon: 'Train' },
                { id: 'c4', name: '房租水電', icon: 'Home' },
                { id: 'c5', name: '學習書籍', icon: 'BookOpen' },
                { id: 'c6', name: '藥妝保養', icon: 'Heart' },
                { id: 'c7', name: '百元商店', icon: 'Construction' },
                { id: 'c8', name: '生活用品', icon: 'Coins' },
                { id: 'c9', name: '通訊網費', icon: 'Wifi' },
                { id: 'c10', name: '娛樂興趣', icon: 'Coffee' },
                { id: 'c11', name: '醫療保險', icon: 'Stethoscope' },
                { id: 'c12', name: '衣物飾品', icon: 'Shirt' },
                { id: 'c13', name: '理髮美容', icon: 'Heart' },
                { id: 'c14', name: '社交禮物', icon: 'Ticket' }
            ],
            incomeCategories: [
                { id: 'i1', name: '薪資收入', icon: 'Coins' },
                { id: 'i2', name: '獎學金', icon: 'BookOpen' },
                { id: 'i3', name: '零用錢', icon: 'Wallet' },
                { id: 'i4', name: '打工收入', icon: 'Construction' },
                { id: 'i5', name: '轉帳匯入', icon: 'Train' },
                { id: 'i6', name: '其他收入', icon: 'Ticket' }
            ],
            payments: [
                { id: 'p1', name: '現金 (日)', icon: 'Coins' },
                { id: 'p2', name: '日幣帳戶', icon: 'Home' },
                { id: 'p3', name: '台幣帳戶', icon: 'Wallet' },
                { id: 'p4', name: 'PayPay', icon: 'Smartphone' },
                { id: 'p5', name: 'Suica', icon: 'Ticket' },
                { id: 'p6', name: '信用卡1', icon: 'CreditCard' },
                { id: 'p7', name: '信用卡2', icon: 'CreditCard' },
                { id: 'p8', name: '信用卡3', icon: 'CreditCard' },
                { id: 'p9', name: 'LINE Pay', icon: 'Smartphone' }
            ],
            initialCostsDefault: []
        };

        let state = {
            transactions: [],
            initialCosts: [],
            initialBudget: 1500000,
            exchangeRate: 0.215,
            categories: [...DEFAULTS.categories],
            incomeCategories: [...DEFAULTS.incomeCategories],
            paymentMethods: [...DEFAULTS.payments],
            activeTab: 'dashboard',
            dashboardMonth: new Date().toISOString().slice(0, 7),
            inputType: 'expense',
            inputCurrency: 'JPY',
            historyFilter: 'month',
            historyDay: new Date().toISOString().split('T')[0],
            historyMonth: new Date().toISOString().slice(0, 7),
            selectedCategory: DEFAULTS.categories[0].id,
            selectedIncomeCategory: DEFAULTS.incomeCategories[0].id,
            selectedPayment: DEFAULTS.payments[0].id,
            editingItem: null, 
            editingTransactionId: null,
            editTransSelectedCategory: null,
            editTransSelectedPayment: null,
            editingInitialId: null
        };

        let myChart = null;

        function saveData() { localStorage.setItem('jp_v18_data', JSON.stringify(state)); }
        function loadData() {
            const saved = localStorage.getItem('jp_v18_data');
            if (saved) {
                try { state = { ...state, ...JSON.parse(saved) }; } catch(e) { console.error("Load failed", e); }
            }
        }

        function openConfirm(title, msg, onConfirm) {
            const modal = document.getElementById('modal-confirm');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            const execBtn = document.getElementById('confirm-execute');
            const newExecBtn = execBtn.cloneNode(true);
            execBtn.parentNode.replaceChild(newExecBtn, execBtn);
            newExecBtn.onclick = () => { onConfirm(); closeConfirm(); };
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        function closeConfirm() { document.getElementById('modal-confirm').classList.add('hidden'); }

        function renderAll() {
            renderDashboard();
            renderAddForm();
            renderHistory();
            renderAccounts();
            renderInitialCosts();
            lucide.createIcons();
        }

        function renderDashboard() {
            const incomeTotal = state.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expenseDaily = state.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const expenseInit = state.initialCosts.reduce((s, e) => s + e.actual, 0);
            const totalAssets = incomeTotal - expenseDaily - expenseInit;

            safeUpdate('dash-total-assets', `¥${totalAssets.toLocaleString()}`);
            safeUpdate('dash-total-twd', `≈ NT$ ${Math.round(totalAssets * state.exchangeRate).toLocaleString()}`);
            safeUpdate('dash-rate', `1 JPY = ${state.exchangeRate} TWD`);

            const filtered = state.transactions.filter(t => t.date.startsWith(state.dashboardMonth));
            const monthInc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const monthExp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

            safeUpdate('dash-month-income', `¥${monthInc.toLocaleString()}`);
            safeUpdate('dash-month-expense', `¥${monthExp.toLocaleString()}`);
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            const filtered = state.transactions.filter(t => t.type === 'expense' && t.date.startsWith(state.dashboardMonth));
            const categoryData = state.categories.map(cat => {
                const total = filtered.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount, 0);
                return { name: cat.name, total, color: ICON_OPTIONS[cat.icon].color };
            }).filter(d => d.total > 0);

            if (myChart) myChart.destroy();
            const legendEmpty = document.getElementById('chart-legend-empty');
            if (legendEmpty) legendEmpty.classList.toggle('hidden', categoryData.length > 0);
            if (categoryData.length === 0) return;

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(d => d.name),
                    datasets: [{ data: categoryData.map(d => d.total), backgroundColor: categoryData.map(d => d.color), borderWidth: 4, borderColor: '#ffffff' }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6, font: { size: 9, weight: 'bold' } } } } }
            });
        }

        function renderAddForm() {
            const isExp = state.inputType === 'expense';
            const list = isExp ? state.categories : state.incomeCategories;
            const currentSel = isExp ? state.selectedCategory : state.selectedIncomeCategory;
            
            const catGrid = document.getElementById('add-category-grid');
            if (catGrid) {
                catGrid.innerHTML = list.map(cat => {
                    const config = ICON_OPTIONS[cat.icon];
                    return `<button type="button" onclick="setSelection('cat', '${cat.id}')" class="flex flex-col items-center gap-1 p-2 rounded-xl border transition-all dynamic-card ${currentSel === cat.id ? 'border-blue-500 bg-blue-50' : 'border-slate-100 bg-white shadow-sm'}"><i data-lucide="${config.icon}" size="18" style="color: ${config.color}"></i><span class="text-[10px] font-black truncate w-full text-center text-slate-500 leading-tight">${cat.name}</span></button>`;
                }).join('');
            }

            const payGrid = document.getElementById('add-payment-grid');
            if (payGrid) {
                payGrid.innerHTML = state.paymentMethods.map(pay => {
                    const config = ICON_OPTIONS[pay.icon];
                    return `<button type="button" onclick="setSelection('pay', '${pay.id}')" class="flex items-center justify-center gap-1.5 p-2 rounded-lg border transition-all text-xs font-black dynamic-card ${state.selectedPayment === pay.id ? 'bg-slate-900 text-white border-slate-900 shadow-md' : 'bg-white text-slate-400 border-slate-100'}"><i data-lucide="${config.icon}" size="10" style="color: ${state.selectedPayment === pay.id ? '#fff' : config.color}"></i><span class="truncate ml-1 leading-tight">${pay.name}</span></button>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function renderHistory() {
            const wrap = document.getElementById('date-input-wrapper');
            if (!wrap) return;
            if (state.historyFilter === 'day') wrap.innerHTML = `<input type="date" value="${state.historyDay}" onchange="changeHistoryDate('day', this.value)" class="bg-transparent outline-none">`;
            else if (state.historyFilter === 'month') wrap.innerHTML = `<input type="month" value="${state.historyMonth}" onchange="changeHistoryDate('month', this.value)" class="bg-transparent outline-none">`;
            else wrap.innerHTML = `<span class="uppercase">全部紀錄</span>`;

            const filtered = state.transactions.filter(e => {
                if (state.historyFilter === 'day') return e.date === state.historyDay;
                if (state.historyFilter === 'month') return e.date.startsWith(state.historyMonth);
                return true;
            });

            safeUpdate('history-period-income', `¥${filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0).toLocaleString()}`);
            safeUpdate('history-period-expense', `¥${filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0).toLocaleString()}`);
            safeUpdate('history-period-balance', `¥${(filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0) - filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0)).toLocaleString()}`);
            
            const list = document.getElementById('history-list');
            if (list) {
                list.innerHTML = filtered.map(t => {
                    const catList = t.type === 'expense' ? state.categories : state.incomeCategories;
                    const cat = catList.find(c => c.id === t.category);
                    const config = ICON_OPTIONS[cat?.icon || 'ShoppingBag'];
                    return `<div class="p-3 px-4 rounded-[1.2rem] flex items-center justify-between shadow-sm dynamic-card border border-white" style="background-color: ${hexToRgba(config.color, 0.05)}; border-left: 4px solid ${config.color}">
                        <div class="flex items-center gap-3">
                            <div class="bg-white/90 p-2 rounded-xl flex items-center justify-center"><i data-lucide="${config.icon}" size="14" style="color: ${config.color}"></i></div>
                            <div><h4 class="font-black text-slate-800 text-[12px] leading-tight">${t.note || cat?.name}</h4><p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${t.date}</p></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right mr-1"><p class="font-black ${t.type === 'income' ? 'income-text' : 'expense-text'} text-[13px] leading-none">${t.type === 'income' ? '+' : '-'}¥${t.amount.toLocaleString()}</p></div>
                            <div class="flex flex-col gap-1"><button onclick="editRecord('${t.id}')" class="p-1 text-slate-300 hover:text-blue-500"><i data-lucide="edit-3" size="14"></i></button><button onclick="deleteRecord('${t.id}')" class="p-1 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" size="14"></i></button></div>
                        </div>
                    </div>`;
                }).join('') || '<p class="text-center py-10 text-slate-300 text-xs font-black uppercase">暫無紀錄</p>';
            }
            lucide.createIcons();
        }

        // --- New: Account Tab Renderer ---
        function renderAccounts() {
            const listEl = document.getElementById('accounts-list');
            if (!listEl) return;
            
            const accounts = state.paymentMethods;
            safeUpdate('account-count', accounts.length);
            
            listEl.innerHTML = accounts.map(acc => {
                const config = ICON_OPTIONS[acc.icon] || { icon: 'wallet', color: '#64748b' };
                
                // Calculate balance for this account
                const accTransactions = state.transactions.filter(t => t.payment === acc.id);
                const accIncome = accTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                const accExpense = accTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                const balance = accIncome - accExpense;
                
                // Get last 3 transactions for preview
                const recentPreview = accTransactions.slice(0, 3).map(t => {
                    const isInc = t.type === 'income';
                    return `<div class="flex justify-between items-center text-[9px] font-bold py-1 border-t border-slate-50">
                        <span class="text-slate-400 truncate w-24">${t.note || '紀錄'}</span>
                        <span class="${isInc ? 'text-emerald-500' : 'text-slate-500'}">${isInc ? '+' : '-'}¥${t.amount.toLocaleString()}</span>
                    </div>`;
                }).join('');

                return `<div class="bg-white rounded-[1.8rem] p-5 border border-white shadow-sm dynamic-card group overflow-hidden relative">
                    <div class="absolute -right-4 -top-4 text-blue-50 opacity-10 rotate-12 group-hover:scale-110 transition-transform">
                        <i data-lucide="${config.icon}" size="80"></i>
                    </div>
                    <div class="flex items-center gap-3 relative z-10 mb-4">
                        <div class="p-3 rounded-2xl bg-slate-50 flex items-center justify-center">
                            <i data-lucide="${config.icon}" size="20" style="color: ${config.color}"></i>
                        </div>
                        <div>
                            <h3 class="font-black text-slate-800 text-sm leading-none">${acc.name}</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">流水筆數：${accTransactions.length}</p>
                        </div>
                    </div>
                    <div class="relative z-10 flex justify-between items-end">
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">目前帳戶餘額</p>
                            <h4 class="text-xl font-black text-slate-800 mt-1">¥${balance.toLocaleString()}</h4>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold text-slate-400">≈ NT$ ${Math.round(balance * state.exchangeRate).toLocaleString()}</p>
                        </div>
                    </div>
                    ${accTransactions.length > 0 ? `
                        <div class="mt-4 pt-2 border-t border-slate-100">
                            <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest mb-1.5">最近往來</p>
                            ${recentPreview}
                        </div>
                    ` : `
                        <div class="mt-4 pt-2 border-t border-slate-100 text-[9px] font-bold text-slate-300 italic">尚無使用此帳戶的交易紀錄</div>
                    `}
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function renderInitialCosts() {
            const actualTotal = state.initialCosts.reduce((s, e) => s + e.actual, 0);
            const budgetLimit = state.initialBudget || 0;
            const progress = budgetLimit > 0 ? Math.min((actualTotal / budgetLimit) * 100, 100) : 0;
            
            safeUpdate('init-total-display', `¥${actualTotal.toLocaleString()}`);
            safeUpdate('init-budget-sum-display', `¥${state.initialCosts.reduce((s, e) => s + e.budget, 0).toLocaleString()}`);
            safeUpdate('init-rem-display', `¥${(budgetLimit - actualTotal).toLocaleString()}`);
            safeUpdate('init-progress-text', `${progress.toFixed(1)}%`);
            
            document.getElementById('init-budget-input').value = budgetLimit / 10000;
            const bar = document.getElementById('init-progress-bar');
            if (bar) bar.style.width = `${progress}%`;
            
            const list = document.getElementById('initial-costs-list');
            if (list) {
                list.innerHTML = state.initialCosts.map(item => {
                    const statusColor = item.actual > item.budget ? "#ef4444" : "#3b82f6";
                    return `<div class="p-2.5 px-4 rounded-2xl border border-white shadow-sm flex flex-col gap-1" style="background-color: ${hexToRgba(statusColor, 0.04)}; border-left: 4px solid ${statusColor}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 overflow-hidden"><span class="font-black text-[13px] text-slate-800 leading-none truncate block">${item.name}</span><p class="text-[11px] text-slate-400 font-bold truncate mt-1">${item.note || '無備註'}</p></div>
                            <div class="flex gap-2 ml-2"><button onclick="editInitialCost('${item.id}')" class="text-slate-200 hover:text-blue-500"><i data-lucide="edit-3" size="14"></i></button><button onclick="deleteInitial('${item.id}')" class="text-slate-200 hover:text-red-400"><i data-lucide="trash-2" size="14"></i></button></div>
                        </div>
                        <div class="flex justify-between items-center mt-1"><span class="text-[10px] font-black text-slate-400">預算 ¥${item.budget.toLocaleString()}</span><span class="font-black text-slate-700 text-[13px]">實際 ¥${item.actual.toLocaleString()}</span></div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        // --- Logic Actions ---
        function updateRate(val) { state.exchangeRate = parseFloat(val) || 0; saveData(); renderDashboard(); renderAccounts(); }
        function updateInitialBudget(val) { state.initialBudget = (parseFloat(val) || 0) * 10000; saveData(); renderInitialCosts(); renderDashboard(); }

        function setInputType(type) { 
            state.inputType = type; 
            const bExp = document.getElementById('btn-type-expense');
            const bInc = document.getElementById('btn-type-income');
            const isExp = type === 'expense';
            bExp.className = isExp ? 'py-2.5 rounded-2xl text-xs font-black transition-all bg-white text-slate-700 shadow-sm flex items-center justify-center gap-1.5' : 'py-2.5 rounded-2xl text-xs font-black transition-all text-slate-500 flex items-center justify-center gap-1.5';
            bInc.className = !isExp ? 'py-2.5 rounded-2xl text-xs font-black transition-all bg-white text-emerald-600 shadow-sm flex items-center justify-center gap-1.5' : 'py-2.5 rounded-2xl text-xs font-black transition-all text-slate-500 flex items-center justify-center gap-1.5';
            renderAddForm(); 
        }

        function setInputCurrency(c) { 
            state.inputCurrency = c; 
            const bj = document.getElementById('btn-jpy');
            const bt = document.getElementById('btn-twd');
            bj.className = `px-3 py-1.5 rounded-lg text-xs font-black transition-all ${c === 'JPY' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`;
            bt.className = `px-3 py-1.5 rounded-lg text-xs font-black transition-all ${c === 'TWD' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`;
            safeUpdate('input-label', `金額紀錄 (${c})`); 
            safeUpdate('currency-symbol', c === 'JPY' ? '¥' : '$'); 
            renderAddForm(); 
        }

        function setFilter(f) { 
            state.historyFilter = f; 
            document.querySelectorAll('#history-filter button').forEach(btn => {
                const isActive = btn.id.includes(f);
                btn.className = `px-3 py-1 rounded-lg text-xs font-black uppercase transition-all ${isActive ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`;
            });
            renderHistory(); 
        }

        function saveTransaction(event) {
            event.preventDefault();
            const amtText = document.getElementById('input-amount').value;
            const amt = parseFloat(amtText || 0);
            if (amt <= 0) return;
            const jpy = state.inputCurrency === 'JPY' ? amt : amt / state.exchangeRate;
            state.transactions.unshift({
                id: Date.now().toString(), type: state.inputType, amount: Math.round(jpy),
                twd: Math.round(jpy * state.exchangeRate), category: state.inputType === 'expense' ? state.selectedCategory : state.selectedIncomeCategory,
                payment: state.selectedPayment, date: document.getElementById('input-date').value, note: document.getElementById('input-note').value
            });
            saveData();
            switchTab('history');
            document.getElementById('input-amount').value = '';
            document.getElementById('input-note').value = '';
        }

        function editRecord(id) {
            const t = state.transactions.find(item => item.id === id);
            if (!t) return;
            state.editingTransactionId = id;
            state.editTransSelectedCategory = t.category;
            state.editTransSelectedPayment = t.payment;
            document.getElementById('edit-trans-amount').value = t.amount;
            document.getElementById('edit-trans-date').value = t.date;
            document.getElementById('edit-trans-note').value = t.note || '';
            renderEditTransactionGrids(t.type);
            document.getElementById('modal-transaction-edit').classList.remove('hidden');
            lucide.createIcons();
        }
        function renderEditTransactionGrids(type) {
            const list = type === 'expense' ? state.categories : state.incomeCategories;
            document.getElementById('edit-trans-cat-grid').innerHTML = list.map(cat => `<button onclick="setEditTransSelection('cat', '${cat.id}')" class="flex flex-col items-center gap-1 p-2 rounded-xl border ${state.editTransSelectedCategory === cat.id ? 'border-blue-500 bg-blue-50' : 'border-slate-100 bg-white'}"><i data-lucide="${ICON_OPTIONS[cat.icon].icon}" size="16" style="color: ${ICON_OPTIONS[cat.icon].color}"></i><span class="text-[10px] font-black truncate w-full text-center leading-tight">${cat.name}</span></button>`).join('');
            document.getElementById('edit-trans-pay-grid').innerHTML = state.paymentMethods.map(pay => `<button onclick="setEditTransSelection('pay', '${pay.id}')" class="flex items-center justify-center gap-1 p-2 rounded-lg border ${state.editTransSelectedPayment === pay.id ? 'bg-slate-800 text-white' : 'bg-white text-slate-400 border-slate-100'}"><i data-lucide="${ICON_OPTIONS[pay.icon].icon}" size="10" style="color: ${state.editTransSelectedPayment === pay.id ? '#fff' : ICON_OPTIONS[pay.icon].color}"></i><span class="truncate ml-1 text-[10px] font-black leading-tight">${pay.name}</span></button>`).join('');
            lucide.createIcons();
        }
        function setEditTransSelection(type, id) {
            if (type === 'cat') state.editTransSelectedCategory = id;
            else state.editTransSelectedPayment = id;
            const t = state.transactions.find(item => item.id === state.editingTransactionId);
            renderEditTransactionGrids(t.type);
        }
        function saveTransactionEdit() {
            const idx = state.transactions.findIndex(item => item.id === state.editingTransactionId);
            const amt = parseFloat(document.getElementById('edit-trans-amount').value);
            state.transactions[idx] = { ...state.transactions[idx], amount: Math.round(amt), twd: Math.round(amt * state.exchangeRate), date: document.getElementById('edit-trans-date').value, note: document.getElementById('edit-trans-note').value, category: state.editTransSelectedCategory, payment: state.editTransSelectedPayment };
            saveData(); closeTransactionEditModal(); renderAll();
        }
        function closeTransactionEditModal() { document.getElementById('modal-transaction-edit').classList.add('hidden'); }

        function addItem(type) {
            const id = type + Date.now();
            const key = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' }[type];
            state[key].push({ id, name: '新項目', icon: 'ShoppingBag' });
            saveData(); openEditModal(type, id);
        }
        function openEditModal(type, id) {
            const key = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' }[type];
            const item = state[key].find(i => i.id === id);
            state.editingItem = { type, id, tempIcon: item.icon };
            document.getElementById('edit-name').value = item.name;
            renderIconGrid();
            document.getElementById('modal-edit').classList.remove('hidden');
        }
        function renderIconGrid() {
            document.getElementById('edit-icon-grid').innerHTML = Object.keys(ICON_OPTIONS).map(k => `<button onclick="setEditIcon('${k}')" class="p-2.5 rounded-xl flex items-center justify-center ${state.editingItem.tempIcon === k ? 'bg-blue-100 ring-2 ring-blue-500' : 'opacity-50 grayscale hover:opacity-100'}"><i data-lucide="${ICON_OPTIONS[k].icon}" style="color: ${ICON_OPTIONS[k].color}" size="20"></i></button>`).join('');
            lucide.createIcons();
        }
        function setEditIcon(k) { state.editingItem.tempIcon = k; renderIconGrid(); }
        function saveItemEdit() {
            const { type, id, tempIcon } = state.editingItem;
            const name = document.getElementById('edit-name').value.trim();
            const key = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' }[type];
            state[key] = state[key].map(i => i.id === id ? { ...i, name, icon: tempIcon } : i);
            saveData(); closeEditModal(); renderSettings(); renderAll();
        }
        function closeEditModal() { document.getElementById('modal-edit').classList.add('hidden'); }

        function saveInitialCost(e) {
            e.preventDefault();
            const n = document.getElementById('init-input-name').value;
            if (!n) return;
            state.initialCosts.unshift({ id: Date.now().toString(), name: n, budget: parseFloat(document.getElementById('init-input-budget').value) || 0, actual: parseFloat(document.getElementById('init-input-actual').value) || 0, note: document.getElementById('init-input-note').value });
            saveData(); renderInitialCosts(); renderDashboard();
            document.getElementById('init-input-name').value = ''; document.getElementById('init-input-budget').value = ''; document.getElementById('init-input-actual').value = ''; document.getElementById('init-input-note').value = '';
        }
        function editInitialCost(id) {
            const item = state.initialCosts.find(i => i.id === id);
            state.editingInitialId = id;
            document.getElementById('edit-init-name').value = item.name;
            document.getElementById('edit-init-note').value = item.note || '';
            document.getElementById('edit-init-budget').value = item.budget;
            document.getElementById('edit-init-actual').value = item.actual;
            document.getElementById('modal-initial-edit').classList.remove('hidden');
        }
        function saveInitialEdit() {
            const idx = state.initialCosts.findIndex(i => i.id === state.editingInitialId);
            state.initialCosts[idx] = { ...state.initialCosts[idx], name: document.getElementById('edit-init-name').value, note: document.getElementById('edit-init-note').value, budget: parseFloat(document.getElementById('edit-init-budget').value) || 0, actual: parseFloat(document.getElementById('edit-init-actual').value) || 0 };
            saveData(); document.getElementById('modal-initial-edit').classList.add('hidden'); renderInitialCosts(); renderDashboard();
        }
        function closeInitialEditModal() { document.getElementById('modal-initial-edit').classList.add('hidden'); }

        function deleteRecord(id) { openConfirm('刪除紀錄', '確定要刪除嗎？', () => { state.transactions = state.transactions.filter(t => t.id !== id); saveData(); renderAll(); }); }
        function deleteInitial(id) { openConfirm('移除開支', '確定要移除嗎？', () => { state.initialCosts = state.initialCosts.filter(i => i.id !== id); saveData(); renderAll(); }); }
        function deleteItem(type, id) {
            openConfirm('移除項目', '確定要刪除嗎？', () => {
                const key = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' }[type];
                state[key] = state[key].filter(i => i.id !== id);
                saveData(); renderSettings(); renderAll();
            });
        }
        function confirmResetApp() { openConfirm('清除所有資料', '警告：此操作不可還原！', () => { localStorage.removeItem('jp_v18_data'); window.location.reload(); }); }

        function toggleSettings(show) { document.getElementById('modal-settings').classList.toggle('hidden', !show); if (show) renderSettings(); }
        function renderSettings() {
            const rList = (id, list, type) => {
                document.getElementById(id).innerHTML = list.map(item => `
                    <div class="bg-slate-50 p-2.5 px-4 rounded-xl flex justify-between items-center mb-1.5 shadow-inner border border-slate-100">
                        <div class="flex items-center gap-2">
                            <div class="w-6 flex justify-center items-center"><i data-lucide="${ICON_OPTIONS[item.icon]?.icon || 'help-circle'}" size="14" style="color: ${ICON_OPTIONS[item.icon]?.color || '#ccc'}"></i></div>
                            <span class="text-sm font-black text-slate-700 leading-tight">${item.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openEditModal('${type}', '${item.id}')"><i data-lucide="edit-3" size="14" class="text-slate-400"></i></button>
                            <button onclick="deleteItem('${type}', '${item.id}')"><i data-lucide="trash-2" size="14" class="text-slate-400"></i></button>
                        </div>
                    </div>`).join('');
            };
            rList('settings-cat-list', state.categories, 'cat');
            rList('settings-inc-list', state.incomeCategories, 'inc');
            rList('settings-pay-list', state.paymentMethods, 'pay');
            lucide.createIcons();
        }

        function switchTab(tabId) {
            state.activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            renderAll();
        }
        function setSelection(type, id) {
            if (type === 'cat') { if (state.inputType === 'expense') state.selectedCategory = id; else state.selectedIncomeCategory = id; }
            else state.selectedPayment = id;
            renderAddForm();
        }
        function safeUpdate(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
        function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        function changeDashboardMonth(v) { state.dashboardMonth = v; saveData(); renderDashboard(); }
        function changeHistoryDate(t, v) { if(t==='day') state.historyDay=v; if(t==='month') state.historyMonth=v; saveData(); renderHistory(); }
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = `Japan_Expense_Backup.json`; link.click();
        }
        function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { try { state = JSON.parse(e.target.result); saveData(); window.location.reload(); } catch(err) { alert('匯入失敗！'); } };
            reader.readAsText(file);
        }

        window.onload = () => {
            loadData();
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('dash-month-input').value = state.dashboardMonth;
            document.getElementById('set-rate').value = state.exchangeRate;
            switchTab(state.activeTab);
        };
    </script>
</body>
</html>