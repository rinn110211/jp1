<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8FAFC;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .tab-content {
            display: none;
            animation: cardSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes cardSlideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-btn {
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-btn.active {
            color: #2563eb;
            transform: scale(1.1) translateY(-6px);
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            width: 0;
            height: 3px;
            background: #2563eb;
            border-radius: 99px;
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }

        .nav-btn.active::after {
            width: 14px;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dynamic-card {
            transition: all 0.2s ease;
        }

        .dynamic-card:active {
            transform: scale(0.97);
        }

        .floating-nav {
            bottom: 20px;
            left: 16px;
            right: 16px;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .income-text { color: #059669; }
        .expense-text { color: #334155; }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="max-w-md mx-auto flex flex-col bg-slate-50 border-x border-slate-100 shadow-2xl">

    <!-- Header -->
    <header class="glass-effect sticky top-0 z-40 p-3 flex justify-between items-center px-6">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-1.5 rounded-xl text-white shadow-md shadow-blue-100">
                <i data-lucide="japanese-yen" size="18" stroke-width="3"></i>
            </div>
        </div>
        <button onclick="toggleSettings(true)" class="p-2 text-slate-400 bg-white rounded-xl border border-slate-100 shadow-sm active:scale-90 transition-all">
            <i data-lucide="settings" size="20"></i>
        </button>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="scroll-area" class="flex-1 overflow-y-auto scrollbar-hide px-4 pt-3 pb-44">
        
        <!-- Dashboard Tab -->
        <section id="tab-dashboard" class="tab-content active space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-black text-slate-800 tracking-tight">è³‡ç”¢æ¦‚è¦½</h2>
                <div class="bg-white border border-slate-100 px-2 py-1 rounded-xl shadow-sm">
                    <input type="month" id="dash-month-input" onchange="changeDashboardMonth(this.value)" class="text-[10px] font-bold text-blue-600 border-none bg-transparent outline-none cursor-pointer">
                </div>
            </div>

            <!-- è³‡ç”¢é¤˜é¡å¡ç‰‡ -->
            <div class="bg-white rounded-[2rem] p-6 border border-blue-50 shadow-[0_12px_35px_rgba(37,99,235,0.06)] relative overflow-hidden group dynamic-card">
                <div class="absolute -top-6 -right-6 p-4 text-blue-100 opacity-20 rotate-12 transition-transform duration-1000">
                    <i data-lucide="wallet" size="120"></i>
                </div>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest relative z-10 opacity-70">é ä¼°å‰©é¤˜è³‡ç”¢ (å«åˆæœŸæ‰£é™¤)</p>
                <h2 id="dash-total-assets" class="text-3xl font-black mt-1 text-slate-800 tracking-tighter relative z-10">Â¥0</h2>
                <div class="mt-4 flex justify-between items-center relative z-10">
                    <span id="dash-total-twd" class="font-black text-blue-600 bg-blue-50 px-3 py-1.5 rounded-xl text-xs">â‰ˆ NT$ 0</span>
                    <span id="dash-rate" class="text-[9px] font-bold text-slate-300">1 JPY = 0.215 TWD</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 shadow-sm text-center dynamic-card">
                    <p class="text-[9px] text-emerald-600 font-black uppercase mb-0.5">è©²æœˆæ”¶å…¥</p>
                    <p id="dash-month-income" class="font-black text-base text-emerald-700">Â¥0</p>
                </div>
                <div class="bg-slate-100 p-4 rounded-2xl border border-slate-200 shadow-sm text-center dynamic-card">
                    <p class="text-[9px] text-slate-500 font-black uppercase mb-0.5">è©²æœˆæ”¯å‡º</p>
                    <p id="dash-month-expense" class="font-black text-base text-slate-800">Â¥0</p>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">æ”¯å‡ºé¡åˆ¥åˆ†å¸ƒ</h3>
                <div class="relative h-48 w-full flex justify-center">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div id="chart-legend-empty" class="hidden text-center py-4 text-slate-300 text-[10px] font-bold italic">è©²æœˆä»½ç›®å‰ç„¡æ”¯å‡ºæ•¸æ“š</div>
            </div>
        </section>

        <!-- Add Tab -->
        <section id="tab-add" class="tab-content space-y-5">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800">æ–°å¢ç´€éŒ„</h2>
                <div class="bg-slate-200/50 p-1 rounded-xl flex gap-1 shadow-inner">
                    <button onclick="setInputCurrency('JPY')" id="btn-jpy" class="px-3 py-1.5 rounded-lg text-[9px] font-black transition-all bg-white text-blue-600 shadow-sm">JPY</button>
                    <button onclick="setInputCurrency('TWD')" id="btn-twd" class="px-3 py-1.5 rounded-lg text-[9px] font-black transition-all text-slate-500">TWD</button>
                </div>
            </div>

            <div class="grid grid-cols-2 bg-slate-200/50 p-1 rounded-[18px] shadow-inner">
                <button onclick="setInputType('expense')" id="btn-type-expense" class="py-2.5 rounded-2xl text-[11px] font-black transition-all bg-white text-slate-700 shadow-sm flex items-center justify-center gap-1.5">
                    <i data-lucide="arrow-down-right" size="14"></i> æ”¯å‡ºé …ç›®
                </button>
                <button onclick="setInputType('income')" id="btn-type-income" class="py-2.5 rounded-2xl text-[11px] font-black transition-all text-slate-500 flex items-center justify-center gap-1.5">
                    <i data-lucide="arrow-up-right" size="14"></i> æ”¶å…¥ä¾†æº
                </button>
            </div>

            <form onsubmit="saveTransaction(event)" class="space-y-4">
                <div class="bg-white p-5 rounded-2xl shadow-lg border border-blue-50 relative overflow-hidden">
                    <div id="input-bg-accent" class="absolute top-0 right-0 w-16 h-16 bg-slate-100 rounded-full -mr-8 -mt-8 transition-all duration-700"></div>
                    <label id="input-label" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest relative z-10">é‡‘é¡ç´€éŒ„</label>
                    <div class="flex items-center mt-1 border-b border-slate-100 pb-1 focus-within:border-blue-500 relative z-10 transition-colors">
                        <span id="currency-symbol" class="text-xl font-black text-slate-300">Â¥</span>
                        <input type="number" step="any" id="input-amount" class="w-full bg-transparent border-none text-3xl font-black focus:ring-0 ml-1 text-slate-800 outline-none" placeholder="0">
                    </div>
                    <p id="conversion-hint" class="mt-2 text-[10px] font-bold text-blue-400 hidden flex items-center gap-1 relative z-10"></p>
                </div>

                <div class="flex gap-2">
                    <div class="flex-1 bg-white p-0.5 rounded-xl border border-slate-100 shadow-sm">
                        <input type="date" id="input-date" class="w-full bg-transparent p-2.5 text-[10px] font-black outline-none text-slate-600">
                    </div>
                    <div class="flex-[1.5] bg-white p-0.5 rounded-xl border border-slate-100 shadow-sm">
                        <input type="text" id="input-note" placeholder="å¯«é»å‚™è¨»..." class="w-full bg-transparent p-2.5 text-[10px] font-black outline-none text-slate-600">
                    </div>
                </div>

                <div class="space-y-2">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ†é¡</p>
                    <div class="grid grid-cols-4 gap-2" id="add-category-grid"></div>
                </div>

                <div class="space-y-2">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">æ”¯ä»˜ç®¡é“</p>
                    <div class="grid grid-cols-3 gap-2" id="add-payment-grid"></div>
                </div>

                <button type="submit" id="save-btn" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm">
                    <i data-lucide="check" size="18"></i> ç¢ºèªå­˜å…¥å¸³æœ¬
                </button>
            </form>
        </section>

        <!-- History Tab -->
        <section id="tab-history" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-xl font-black text-slate-800">æ­·å²æ˜ç´°</h2>
                <div class="flex bg-slate-200/50 p-1 rounded-xl shadow-inner" id="history-filter">
                    <button onclick="setFilter('day')" id="filter-day" class="px-3 py-1 rounded-lg text-[9px] font-black uppercase transition-all text-slate-500">æœ¬æ—¥</button>
                    <button onclick="setFilter('month')" id="filter-month" class="px-3 py-1 rounded-lg text-[9px] font-black uppercase transition-all bg-white text-blue-600 shadow-sm">æœ¬æœˆ</button>
                    <button onclick="setFilter('all')" id="filter-all" class="px-3 py-1 rounded-lg text-[9px] font-black uppercase transition-all text-slate-500">å…¨éƒ¨</button>
                </div>
            </div>

            <div class="glass-effect p-3 px-4 rounded-2xl flex items-center justify-between shadow-sm">
                <span id="date-selector-label" class="text-[10px] font-black text-slate-400 uppercase">ç¯©é¸ç¯„åœ</span>
                <div id="date-input-wrapper" class="font-bold text-blue-600 text-xs"></div>
            </div>

            <div class="bg-white p-5 rounded-[1.8rem] border border-slate-100 shadow-sm space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] font-bold text-slate-400 uppercase">å€é–“æ”¶å…¥åˆè¨ˆ</span>
                    <span id="history-period-income" class="text-emerald-600 font-black text-xs">Â¥0</span>
                </div>
                <div class="flex justify-between items-center border-t border-slate-50 pt-2">
                    <span class="text-[9px] font-bold text-slate-400 uppercase">å€é–“æ”¯å‡ºåˆè¨ˆ</span>
                    <span id="history-period-expense" class="text-slate-700 font-black text-xs">Â¥0</span>
                </div>
                <div class="flex justify-between items-center border-t-2 border-blue-50 pt-2 mt-1">
                    <span class="text-[10px] font-black text-slate-800 uppercase">å€é–“ç¸½æç›Š</span>
                    <span id="history-period-balance" class="text-blue-600 font-black text-base">Â¥0</span>
                </div>
            </div>

            <div id="history-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- Initial Costs Tab -->
        <section id="tab-initial" class="tab-content space-y-4">
            <div class="bg-white rounded-[1.8rem] p-5 border border-blue-50 shadow-sm relative overflow-hidden dynamic-card">
                <div class="absolute -top-4 -right-4 p-4 text-blue-50 opacity-30 rotate-12"><i data-lucide="plane" size="80"></i></div>
                <div class="flex justify-between items-center mb-1">
                    <div>
                        <p class="text-slate-400 text-[9px] font-bold uppercase tracking-widest relative z-10">å¯¦éš›ç¸½é–‹éŠ·</p>
                        <h2 id="init-total-display" class="text-2xl font-black text-slate-800 relative z-10">Â¥0</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-400 text-[9px] font-bold uppercase tracking-widest relative z-10">å‰©é¤˜é ç®—</p>
                        <h2 id="init-rem-display" class="text-xl font-black text-blue-600 relative z-10">Â¥0</h2>
                    </div>
                </div>
                
                <div class="mt-3 relative h-1 bg-slate-100 rounded-full overflow-hidden z-10">
                    <div id="init-progress-bar" class="h-full bg-blue-600 transition-all duration-1000 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-1.5 text-[9px] font-black uppercase text-slate-400 relative z-10">
                    <span>é ç®—é€²åº¦</span>
                    <span id="init-progress-text" class="text-blue-600 font-bold">0%</span>
                </div>
            </div>

            <div class="bg-white p-3.5 rounded-2xl border border-blue-100 shadow-sm flex items-center justify-between">
                <div>
                    <h4 class="text-[9px] font-black text-blue-500 uppercase tracking-widest">åˆæœŸé ç®—ä¸Šé™è¨­å®š</h4>
                    <div class="flex items-center gap-1 mt-0.5">
                        <span class="text-xs font-black text-slate-700">Â¥</span>
                        <input type="number" id="init-budget-input" oninput="updateInitialBudget(this.value)" class="w-16 bg-slate-50 border-none rounded-lg p-1 text-xs font-black text-blue-600 outline-none" placeholder="0">
                        <span class="text-[10px] font-bold text-slate-400">è¬</span>
                    </div>
                </div>
                <div class="bg-blue-50 p-1.5 rounded-lg text-blue-600">
                    <i data-lucide="target" size="16"></i>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-md space-y-3">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">æ–°å¢åˆæœŸé–‹æ”¯</h3>
                <form onsubmit="saveInitialCost(event)" class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="init-input-name" placeholder="é …ç›®" class="w-full bg-slate-50 border-none rounded-lg p-2.5 text-[11px] font-black outline-none focus:ring-1 focus:ring-blue-100 transition-all">
                        <input type="text" id="init-input-note" placeholder="è©³ç´°å‚™è¨»" class="w-full bg-slate-50 border-none rounded-lg p-2.5 text-[11px] font-black outline-none focus:ring-1 focus:ring-blue-100 transition-all">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 flex items-center bg-slate-50 rounded-lg px-2 border border-slate-100">
                            <span class="text-[8px] font-bold text-slate-400 mr-1 shrink-0">é ç®—</span>
                            <input type="number" id="init-input-budget" placeholder="Â¥" class="w-full bg-transparent p-2 text-[11px] font-black outline-none">
                        </div>
                        <div class="flex-1 flex items-center bg-slate-50 rounded-lg px-2 border border-slate-100">
                            <span class="text-[8px] font-bold text-slate-400 mr-1 shrink-0">å¯¦éš›</span>
                            <input type="number" id="init-input-actual" placeholder="Â¥" class="w-full bg-transparent p-2 text-[11px] font-black outline-none">
                        </div>
                        <button type="submit" class="bg-slate-900 text-white px-4 rounded-lg font-black shadow-lg active:scale-90 transition-all">
                            <i data-lucide="plus" size="16"></i>
                        </button>
                    </div>
                </form>
            </div>

            <div id="initial-costs-list" class="space-y-2 pb-20"></div>
        </section>
    </main>

    <!-- æ‡¸æµ®å°è¦½åˆ— -->
    <nav class="floating-nav glass-effect fixed max-w-md mx-auto py-3 px-8 flex justify-between items-center z-40">
        <button onclick="switchTab('add')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="add">
            <i data-lucide="plus-circle" size="22"></i>
            <span class="text-[8px] font-black tracking-widest uppercase">æ–°å¢</span>
        </button>
        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="history">
            <i data-lucide="list" size="22"></i>
            <span class="text-[8px] font-black tracking-widest uppercase">æ˜ç´°</span>
        </button>
        <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center gap-1 text-slate-300 active" data-tab="dashboard">
            <i data-lucide="layout-dashboard" size="22"></i>
            <span class="text-[8px] font-black tracking-widest uppercase">ç¸½è¦½</span>
        </button>
        <button onclick="switchTab('initial')" class="nav-btn flex flex-col items-center gap-1 text-slate-300" data-tab="initial">
            <i data-lucide="calculator" size="22"></i>
            <span class="text-[8px] font-black tracking-widest uppercase">åˆæœŸ</span>
        </button>
    </nav>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6 modal-backdrop">
        <div class="bg-white w-full max-w-sm rounded-[2.2rem] p-7 shadow-2xl relative animate-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-black text-slate-800">è³‡æ–™èˆ‡å‚™ä»½ç®¡ç†</h2>
                <button onclick="toggleSettings(false)" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" size="18"></i></button>
            </div>
            
            <div class="space-y-5 max-h-[60vh] overflow-y-auto scrollbar-hide pr-1">
                <section class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                    <h3 class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-3">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportData()" class="flex flex-col items-center gap-1.5 p-3 bg-white rounded-xl border border-blue-100 shadow-sm active:scale-95 transition-all">
                            <i data-lucide="download" size="18" class="text-blue-600"></i>
                            <span class="text-[10px] font-bold text-slate-600">åŒ¯å‡ºå‚™ä»½æª”</span>
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex flex-col items-center gap-1.5 p-3 bg-white rounded-xl border border-blue-100 shadow-sm active:scale-95 transition-all">
                            <i data-lucide="upload" size="18" class="text-blue-600"></i>
                            <span class="text-[10px] font-bold text-slate-600">åŒ¯å…¥å‚™ä»½æª”</span>
                        </button>
                    </div>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                    <p class="text-[8px] text-slate-400 mt-2 leading-tight">ğŸ’¡ å»ºè­°æ¯æœˆå°‡è³‡æ–™åŒ¯å‡ºå„²å­˜æ–¼ Google Driveï¼Œä»¥é˜²æ‰‹æ©Ÿéºå¤±æˆ–ç€è¦½å™¨å¿«å–è¢«æ¸…ç©ºã€‚</p>
                </section>

                <section>
                    <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">åŒ¯ç‡è¨­å®š</h3>
                    <div class="bg-blue-50 p-3.5 rounded-2xl flex justify-between items-center shadow-inner border border-blue-100">
                        <span class="text-[10px] font-black text-blue-600">1 JPY =</span>
                        <input type="number" step="0.001" id="set-rate" class="w-20 bg-white border-none rounded-xl p-2 text-right font-black text-blue-600 outline-none shadow-sm">
                    </div>
                </section>
                <section>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">æ”¯å‡ºåˆ†é¡</h3>
                        <button onclick="addItem('cat')" class="text-[9px] font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">æ–°å¢</button>
                    </div>
                    <div id="settings-cat-list" class="space-y-1.5"></div>
                </section>
                <section>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">æ”¶å…¥åˆ†é¡</h3>
                        <button onclick="addItem('inc')" class="text-[9px] font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">æ–°å¢</button>
                    </div>
                    <div id="settings-inc-list" class="space-y-1.5"></div>
                </section>
                <section>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">æ”¯ä»˜å¸³æˆ¶</h3>
                        <button onclick="addItem('pay')" class="text-[9px] font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg">æ–°å¢</button>
                    </div>
                    <div id="settings-pay-list" class="space-y-1.5"></div>
                </section>
                <button onclick="resetApp()" class="w-full text-red-400 text-[9px] font-black py-4 bg-red-50 rounded-2xl tracking-widest uppercase hover:bg-red-100 transition-colors mt-4">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal (ç”¨æ–¼é¡åˆ¥ã€å¸³æˆ¶) -->
    <div id="modal-edit" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-7 shadow-2xl animate-in zoom-in duration-200">
            <div class="flex justify-between items-center mb-5">
                <h3 id="edit-modal-title" class="text-base font-black text-slate-800 px-2">ç·¨è¼¯</h3>
                <button onclick="closeEditModal()" class="p-2 bg-slate-50 rounded-full text-slate-400"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="space-y-6">
                <input id="edit-name" type="text" class="w-full bg-slate-50 border-none rounded-2xl p-4 font-black outline-none shadow-inner text-slate-700 text-sm" placeholder="è¼¸å…¥åç¨±">
                <div id="edit-icon-grid" class="grid grid-cols-5 gap-2.5 max-h-40 overflow-y-auto bg-slate-50 rounded-[1.8rem] p-4 scrollbar-hide border border-slate-100"></div>
                <button onclick="saveItemEdit()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all text-sm">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Transaction Edit Modal -->
    <div id="modal-transaction-edit" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-7 shadow-2xl animate-in zoom-in duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-black text-slate-800 px-2">ç·¨è¼¯äº¤æ˜“æ˜ç´°</h3>
                <button onclick="closeTransactionEditModal()" class="p-2 bg-slate-50 rounded-full text-slate-400"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto scrollbar-hide p-1">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">é‡‘é¡ (ç•¶å‰å¹£åˆ¥)</label>
                    <input type="number" id="edit-trans-amount" class="w-full bg-transparent border-none text-2xl font-black focus:ring-0 text-slate-800 outline-none" placeholder="0">
                </div>
                <div class="flex gap-2">
                    <input type="date" id="edit-trans-date" class="flex-1 bg-slate-50 rounded-xl p-2.5 text-[10px] font-black outline-none border border-slate-100 text-slate-600">
                    <input type="text" id="edit-trans-note" placeholder="å‚™è¨»..." class="flex-1 bg-slate-50 rounded-xl p-2.5 text-[10px] font-black outline-none border border-slate-100 text-slate-600">
                </div>
                <div class="space-y-1">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ†é¡</p>
                    <div class="grid grid-cols-4 gap-2" id="edit-trans-cat-grid"></div>
                </div>
                <div class="space-y-1">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">æ”¯ä»˜ç®¡é“</p>
                    <div class="grid grid-cols-3 gap-2" id="edit-trans-pay-grid"></div>
                </div>
                <button onclick="saveTransactionEdit()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-xl active:scale-95 transition-all text-sm mt-4">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script>
        const ICON_OPTIONS = {
            ShoppingBag: { icon: 'shopping-bag', color: '#10B981' },
            Utensils: { icon: 'utensils', color: '#F59E0B' },
            Train: { icon: 'train', color: '#3B82F6' },
            Home: { icon: 'home', color: '#6366F1' },
            BookOpen: { icon: 'book-open', color: '#8B5CF6' },
            Coffee: { icon: 'coffee', color: '#A855F7' },
            CreditCard: { icon: 'credit-card', color: '#4B5563' },
            Plane: { icon: 'plane', color: '#0EA5E9' },
            Coins: { icon: 'coins', color: '#EAB308' },
            Wallet: { icon: 'wallet', color: '#D946EF' },
            Smartphone: { icon: 'smartphone', color: '#2DD4BF' },
            AlertCircle: { icon: 'alert-circle', color: '#EF4444' },
            Ticket: { icon: 'ticket', color: '#FACC15' },
            Shirt: { icon: 'shirt', color: '#06B6D4' },
            Wifi: { icon: 'wifi', color: '#2563EB' },
            Stethoscope: { icon: 'stethoscope', color: '#06B6D4' },
            Heart: { icon: 'heart', color: '#F43F5E' },
            Construction: { icon: 'construction', color: '#84CC16' }
        };

        const DEFAULTS = {
            categories: [
                { id: 'c1', name: 'è¶…å¸‚æ¡è²·', icon: 'ShoppingBag' },
                { id: 'c2', name: 'å¤–é£Ÿé¤å»³', icon: 'Utensils' },
                { id: 'c3', name: 'äº¤é€šè²»ç”¨', icon: 'Train' },
                { id: 'c4', name: 'æˆ¿ç§Ÿæ°´é›»', icon: 'Home' },
                { id: 'c5', name: 'å­¸ç¿’æ›¸ç±', icon: 'BookOpen' },
                { id: 'c6', name: 'è—¥å¦ä¿é¤Š', icon: 'Heart' },
                { id: 'c7', name: 'ç™¾å…ƒå•†åº—', icon: 'Construction' },
                { id: 'c8', name: 'ç”Ÿæ´»ç”¨å“', icon: 'Coins' },
                { id: 'c9', name: 'é€šè¨Šç¶²è²»', icon: 'Wifi' },
                { id: 'c10', name: 'å¨›æ¨‚èˆˆè¶£', icon: 'Coffee' },
                { id: 'c11', name: 'é†«ç™‚ä¿éšª', icon: 'Stethoscope' },
                { id: 'c12', name: 'è¡£ç‰©é£¾å“', icon: 'Shirt' }
            ],
            incomeCategories: [
                { id: 'i1', name: 'çå­¸é‡‘', icon: 'BookOpen' },
                { id: 'i2', name: 'é›¶ç”¨éŒ¢', icon: 'Wallet' },
                { id: 'i3', name: 'è–ªè³‡æ”¶å…¥', icon: 'Coins' },
                { id: 'i4', name: 'å…¶ä»–æ”¶å…¥', icon: 'Ticket' }
            ],
            payments: [
                { id: 'p1', name: 'å°å¹£å¸³æˆ¶', icon: 'Wallet' },
                { id: 'p2', name: 'æ—¥å¹£å¸³æˆ¶', icon: 'Home' },
                { id: 'p3', name: 'æ—¥å¹£ç¾é‡‘', icon: 'Coins' },
                { id: 'p4', name: 'PayPay', icon: 'Smartphone' },
                { id: 'p5', name: 'Suica', icon: 'Ticket' },
                { id: 'p6', name: 'ä¿¡ç”¨å¡1', icon: 'CreditCard' },
                { id: 'p7', name: 'ä¿¡ç”¨å¡2', icon: 'CreditCard' },
                { id: 'p8', name: 'ä¿¡ç”¨å¡3', icon: 'CreditCard' }
            ],
            initialBudgetDefault: 0,
            initialCostsDefault: [
                { id: 'd1', name: 'èªè¨€å­¸æ ¡å­¸è²»', budget: 800000, actual: 820000, note: 'åŠå¹´ä»½å­¸è²»å«é›œè²»' },
                { id: 'd2', name: 'ç§Ÿæˆ¿é¦–ä»˜', budget: 300000, actual: 285000, note: 'æŠ¼é‡‘ã€ç¦®é‡‘ã€ä»²ä»‹è²»' },
                { id: 'd3', name: 'æ—¥æœ¬å–®ç¨‹æ©Ÿç¥¨', budget: 15000, actual: 12500, note: 'å–®ç¨‹æ©Ÿç¥¨å«æ‰˜é‹' },
                { id: 'd4', name: 'å®¶å…·å®¶é›»çµ„', budget: 100000, actual: 110000, note: 'å†°ç®±ã€æ´—è¡£æ©Ÿã€å¾®æ³¢çˆ' }
            ]
        };

        let state = {
            transactions: [],
            initialCosts: [...DEFAULTS.initialCostsDefault],
            initialBudget: 0,
            exchangeRate: 0.215,
            categories: [...DEFAULTS.categories],
            incomeCategories: [...DEFAULTS.incomeCategories],
            paymentMethods: [...DEFAULTS.payments],
            activeTab: 'dashboard',
            dashboardMonth: new Date().toISOString().slice(0, 7),
            inputType: 'expense',
            inputCurrency: 'JPY',
            historyFilter: 'month',
            historyDay: new Date().toISOString().split('T')[0],
            historyMonth: new Date().toISOString().slice(0, 7),
            historyYear: new Date().getFullYear().toString(),
            selectedCategory: DEFAULTS.categories[0].id,
            selectedIncomeCategory: DEFAULTS.incomeCategories[0].id,
            selectedPayment: DEFAULTS.payments[0].id,
            editingTransactionId: null,
            editTransSelectedCategory: null,
            editTransSelectedPayment: null
        };

        let myChart = null;

        function safeUpdate(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function saveData() { localStorage.setItem('jp_v17_data', JSON.stringify(state)); }
        
        function loadData() {
            const saved = localStorage.getItem('jp_v17_data');
            if (saved) {
                try {
                    state = { ...state, ...JSON.parse(saved) };
                } catch(e) { console.error("Load failed", e); }
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `JapanExpense_Backup_${date}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (confirm('ç¢ºå®šè¦è¦†è“‹ç¾æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚')) {
                        state = { ...state, ...importedState };
                        saveData();
                        window.location.reload();
                    }
                } catch (err) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼šç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ã€‚');
                }
            };
            reader.readAsText(file);
        }

        function renderAll() {
            renderDashboard();
            renderAddForm();
            renderHistory();
            renderInitialCosts();
            lucide.createIcons();
        }

        function renderDashboard() {
            const incomeTotal = state.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expenseDaily = state.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const expenseInit = state.initialCosts.reduce((s, e) => s + e.actual, 0);
            const totalAssets = incomeTotal - expenseDaily - expenseInit;

            safeUpdate('dash-total-assets', `Â¥${totalAssets.toLocaleString()}`);
            safeUpdate('dash-total-twd', `â‰ˆ NT$ ${Math.round(totalAssets * state.exchangeRate).toLocaleString()}`);
            safeUpdate('dash-rate', `1 JPY = ${state.exchangeRate} TWD`);

            const filtered = state.transactions.filter(t => t.date.startsWith(state.dashboardMonth));
            const monthInc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const monthExp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

            safeUpdate('dash-month-income', `Â¥${monthInc.toLocaleString()}`);
            safeUpdate('dash-month-expense', `Â¥${monthExp.toLocaleString()}`);
        }

        function updateChart() {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            const filtered = state.transactions.filter(t => t.type === 'expense' && t.date.startsWith(state.dashboardMonth));
            const categoryData = state.categories.map(cat => {
                const total = filtered.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount, 0);
                return { name: cat.name, total, color: ICON_OPTIONS[cat.icon].color };
            }).filter(d => d.total > 0);

            const legendEmpty = document.getElementById('chart-legend-empty');
            if (legendEmpty) legendEmpty.classList.toggle('hidden', categoryData.length > 0);
            if (myChart) myChart.destroy();
            if (categoryData.length === 0) return;

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(d => d.name),
                    datasets: [{ data: categoryData.map(d => d.total), backgroundColor: categoryData.map(d => d.color), borderWidth: 4, borderColor: '#ffffff', hoverOffset: 12 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6, padding: 15, font: { size: 9, weight: 'bold' } } } } }
            });
        }

        function renderAddForm() {
            const isExp = state.inputType === 'expense';
            const list = isExp ? state.categories : state.incomeCategories;
            const currentSel = isExp ? state.selectedCategory : state.selectedIncomeCategory;
            
            const catGrid = document.getElementById('add-category-grid');
            if (catGrid) {
                catGrid.innerHTML = list.map(cat => {
                    const active = currentSel === cat.id;
                    const config = ICON_OPTIONS[cat.icon];
                    return `<button type="button" onclick="setSelection('cat', '${cat.id}')" class="flex flex-col items-center gap-1 p-2 rounded-xl border transition-all dynamic-card ${active ? 'border-blue-500 bg-blue-50' : 'border-slate-100 bg-white shadow-sm'}"><i data-lucide="${config.icon}" size="18" style="color: ${config.color}"></i><span class="text-[8px] font-black truncate w-full text-center text-slate-500">${cat.name}</span></button>`;
                }).join('');
            }

            const payGrid = document.getElementById('add-payment-grid');
            if (payGrid) {
                payGrid.innerHTML = state.paymentMethods.map(pay => {
                    const active = state.selectedPayment === pay.id;
                    const config = ICON_OPTIONS[pay.icon];
                    return `<button type="button" onclick="setSelection('pay', '${pay.id}')" class="flex items-center justify-center gap-1.5 p-2 rounded-lg border transition-all text-[9px] font-black dynamic-card ${active ? 'bg-slate-900 text-white border-slate-900 shadow-md' : 'bg-white text-slate-400 border-slate-100'}"><i data-lucide="${config.icon}" size="10" style="color: ${active ? '#fff' : config.color}"></i><span class="truncate">${pay.name}</span></button>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function renderHistory() {
            const wrap = document.getElementById('date-input-wrapper');
            if (!wrap) return;
            if (state.historyFilter === 'day') wrap.innerHTML = `<input type="date" value="${state.historyDay}" onchange="changeHistoryDate('day', this.value)" class="bg-transparent outline-none">`;
            else if (state.historyFilter === 'month') wrap.innerHTML = `<input type="month" value="${state.historyMonth}" onchange="changeHistoryDate('month', this.value)" class="bg-transparent outline-none">`;
            else {
                let years = [...new Set(state.transactions.map(e => e.date.split('-')[0]))];
                const currentYear = new Date().getFullYear().toString();
                if (!years.includes(currentYear)) years.push(currentYear);
                years.sort((a,b) => b-a);
                wrap.innerHTML = `<select onchange="changeHistoryDate('year', this.value)" class="bg-transparent outline-none">${years.map(y => `<option value="${y}" ${y === state.historyYear ? 'selected' : ''}>${y} å¹´</option>`).join('')}</select>`;
            }

            const filtered = state.transactions.filter(e => {
                if (state.historyFilter === 'day') return e.date === state.historyDay;
                if (state.historyFilter === 'month') return e.date.startsWith(state.historyMonth);
                return e.date.startsWith(state.historyYear);
            });

            const inc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            safeUpdate('history-period-income', `Â¥${inc.toLocaleString()}`);
            safeUpdate('history-period-expense', `Â¥${exp.toLocaleString()}`);
            safeUpdate('history-period-balance', `Â¥${(inc-exp).toLocaleString()}`);
            
            const list = document.getElementById('history-list');
            if (list) {
                list.innerHTML = filtered.map(t => {
                    const catList = t.type === 'expense' ? state.categories : state.incomeCategories;
                    const cat = catList.find(c => c.id === t.category);
                    const pay = state.paymentMethods.find(p => p.id === t.payment);
                    const config = ICON_OPTIONS[cat?.icon || 'ShoppingBag'];
                    return `<div class="p-3.5 px-5 rounded-[1.8rem] flex items-center justify-between shadow-sm dynamic-card border border-white" style="background-color: ${hexToRgba(config.color, 0.06)}; border-left: 5px solid ${config.color}">
                        <div class="flex items-center gap-3">
                            <div class="bg-white/80 p-2 rounded-xl"><i data-lucide="${config.icon}" size="16" style="color: ${config.color}"></i></div>
                            <div><h4 class="font-black text-slate-800 text-xs">${t.note || cat?.name}</h4><p class="text-[8px] text-slate-400 font-bold uppercase tracking-tighter">${pay?.name || 'å¸³æˆ¶'} â€¢ ${t.date}</p></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right mr-2">
                                <p class="font-black ${t.type === 'income' ? 'income-text' : 'expense-text'} text-sm">${t.type === 'income' ? '+' : '-'}Â¥${t.amount.toLocaleString()}</p>
                                <p class="text-[8px] text-slate-400 font-bold">NT$ ${t.twd}</p>
                            </div>
                            <div class="flex flex-col gap-0.5 shrink-0">
                                <button onclick="editRecord('${t.id}')" class="p-1.5 text-slate-300 hover:text-blue-500 transition-colors">
                                    <i data-lucide="edit-3" size="14"></i>
                                </button>
                                <button onclick="deleteRecord('${t.id}')" class="p-1.5 text-slate-300 hover:text-red-500 transition-colors">
                                    <i data-lucide="trash-2" size="14"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }).join('') || '<p class="text-center py-10 text-slate-300 text-xs font-black uppercase">æš«ç„¡ç´€éŒ„</p>';
            }
            lucide.createIcons();
        }

        function renderInitialCosts() {
            const totalActual = state.initialCosts.reduce((s, e) => s + e.actual, 0);
            const budget = state.initialBudget || 0;
            const remaining = budget - totalActual;
            const progress = budget > 0 ? Math.min((totalActual / budget) * 100, 100) : 0;
            
            safeUpdate('init-total-display', `Â¥${totalActual.toLocaleString()}`);
            safeUpdate('init-rem-display', `Â¥${remaining.toLocaleString()}`);
            
            const bInput = document.getElementById('init-budget-input');
            if(bInput) bInput.value = budget / 10000;

            const bar = document.getElementById('init-progress-bar');
            if (bar) bar.style.width = `${progress}%`;
            safeUpdate('init-progress-text', `${progress.toFixed(1)}%`);
            
            const list = document.getElementById('initial-costs-list');
            if (list) {
                list.innerHTML = state.initialCosts.map(item => {
                    const isOver = item.actual > item.budget;
                    const statusColor = isOver ? "#ef4444" : "#3b82f6";
                    const bg = hexToRgba(statusColor, 0.04);

                    return `
                    <div class="p-2.5 px-4 rounded-2xl border border-white shadow-sm dynamic-card flex flex-col gap-1" style="background-color: ${bg}; border-left: 4px solid ${statusColor}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 overflow-hidden">
                                <span class="font-black text-xs text-slate-800 leading-none truncate block">${item.name}</span>
                                <p class="text-[9px] text-slate-400 font-bold leading-tight truncate">${item.note || 'ç„¡è©³ç´°å…§å®¹'}</p>
                            </div>
                            <button onclick="deleteInitial('${item.id}')" class="text-slate-200 hover:text-red-400 ml-2"><i data-lucide="trash-2" size="12"></i></button>
                        </div>
                        <div class="flex justify-between items-center mt-0.5">
                            <div class="text-[8px] font-black uppercase text-slate-400 opacity-60">
                                é ç®— Â¥${item.budget.toLocaleString()}
                            </div>
                            <div class="text-right">
                                <span class="text-[8px] font-bold text-slate-400 mr-0.5">å¯¦éš›</span>
                                <span class="font-black text-slate-700 text-xs">Â¥${item.actual.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function editRecord(id) {
            const t = state.transactions.find(item => item.id === id);
            if (!t) return;
            state.editingTransactionId = id;
            state.editTransSelectedCategory = t.category;
            state.editTransSelectedPayment = t.payment;
            
            document.getElementById('edit-trans-amount').value = t.amount;
            document.getElementById('edit-trans-date').value = t.date;
            document.getElementById('edit-trans-note').value = t.note || '';
            
            renderEditTransactionGrids(t.type);
            document.getElementById('modal-transaction-edit').classList.remove('hidden');
            lucide.createIcons();
        }

        function renderEditTransactionGrids(type) {
            const isExp = type === 'expense';
            const catList = isExp ? state.categories : state.incomeCategories;
            
            const catGrid = document.getElementById('edit-trans-cat-grid');
            catGrid.innerHTML = catList.map(cat => {
                const active = state.editTransSelectedCategory === cat.id;
                const config = ICON_OPTIONS[cat.icon];
                return `<button type="button" onclick="setEditTransSelection('cat', '${cat.id}')" class="flex flex-col items-center gap-1 p-2 rounded-xl border transition-all ${active ? 'border-blue-500 bg-blue-50' : 'border-slate-100 bg-white shadow-sm'}"><i data-lucide="${config.icon}" size="16" style="color: ${config.color}"></i><span class="text-[7px] font-black truncate w-full text-center text-slate-500">${cat.name}</span></button>`;
            }).join('');

            const payGrid = document.getElementById('edit-trans-pay-grid');
            payGrid.innerHTML = state.paymentMethods.map(pay => {
                const active = state.editTransSelectedPayment === pay.id;
                const config = ICON_OPTIONS[pay.icon];
                return `<button type="button" onclick="setEditTransSelection('pay', '${pay.id}')" class="flex items-center justify-center gap-1 p-2 rounded-lg border transition-all text-[8px] font-bold ${active ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-400 border-slate-100'}"><i data-lucide="${config.icon}" size="10" style="color: ${active ? '#fff' : config.color}"></i><span class="truncate ml-1">${pay.name}</span></button>`;
            }).join('');
            lucide.createIcons();
        }

        function setEditTransSelection(type, id) {
            if (type === 'cat') state.editTransSelectedCategory = id;
            if (type === 'pay') state.editTransSelectedPayment = id;
            const t = state.transactions.find(item => item.id === state.editingTransactionId);
            renderEditTransactionGrids(t.type);
        }

        function saveTransactionEdit() {
            const id = state.editingTransactionId;
            const tIndex = state.transactions.findIndex(item => item.id === id);
            if (tIndex === -1) return;
            const amount = parseFloat(document.getElementById('edit-trans-amount').value);
            if (!amount || amount <= 0) return;
            const twd = parseFloat((amount * state.exchangeRate).toFixed(1));
            state.transactions[tIndex] = {
                ...state.transactions[tIndex],
                amount: Math.round(amount),
                twd: twd,
                date: document.getElementById('edit-trans-date').value,
                note: document.getElementById('edit-trans-note').value,
                category: state.editTransSelectedCategory,
                payment: state.editTransSelectedPayment
            };
            saveData();
            closeTransactionEditModal();
            renderAll();
            updateChart();
        }

        function closeTransactionEditModal() {
            document.getElementById('modal-transaction-edit').classList.add('hidden');
            state.editingTransactionId = null;
        }

        function updateInitialBudget(val) {
            const parsed = parseFloat(val);
            if (!isNaN(parsed)) {
                state.initialBudget = parsed * 10000;
                saveData();
                renderInitialCosts();
                renderDashboard();
            }
        }

        function switchTab(tabId) {
            state.activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const content = document.getElementById(`tab-${tabId}`);
            if (content) content.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            const scrollArea = document.getElementById('scroll-area');
            if (scrollArea) scrollArea.scrollTop = 0;
            renderAll();
            if (tabId === 'dashboard') setTimeout(updateChart, 100);
        }

        function setInputType(type) {
            state.inputType = type;
            const isExp = type === 'expense';
            const bExp = document.getElementById('btn-type-expense');
            const bInc = document.getElementById('btn-type-income');
            if(bExp) bExp.className = isExp ? 'py-2.5 rounded-2xl text-[11px] font-black transition-all bg-white text-slate-700 shadow-sm flex items-center justify-center gap-1.5' : 'py-2.5 rounded-2xl text-[11px] font-black transition-all text-slate-500 flex items-center justify-center gap-1.5';
            if(bInc) bInc.className = !isExp ? 'py-2.5 rounded-2xl text-[11px] font-black transition-all bg-white text-emerald-600 shadow-sm flex items-center justify-center gap-1.5' : 'py-2.5 rounded-2xl text-[11px] font-black transition-all text-slate-500 flex items-center justify-center gap-1.5';
            const bgAcc = document.getElementById('input-bg-accent');
            if(bgAcc) bgAcc.className = `absolute top-0 right-0 w-16 h-16 ${isExp ? 'bg-slate-100' : 'bg-emerald-50'} rounded-full -mr-8 -mt-8 transition-all duration-700`;
            renderAddForm();
        }

        function setInputCurrency(c) {
            state.inputCurrency = c;
            const bj = document.getElementById('btn-jpy');
            const bt = document.getElementById('btn-twd');
            if(bj) bj.className = `currency-btn px-3 py-1.5 rounded-lg text-[9px] font-black transition-all ${c === 'JPY' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`;
            if(bt) bt.className = `currency-btn px-3 py-1.5 rounded-lg text-[9px] font-black transition-all ${c === 'TWD' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`;
            safeUpdate('input-label', `é‡‘é¡ç´€éŒ„ (${c})`);
            safeUpdate('currency-symbol', c === 'JPY' ? 'Â¥' : '$');
            renderConversionHint();
        }

        function renderConversionHint() {
            const val = parseFloat(document.getElementById('input-amount')?.value || 0);
            const hintEl = document.getElementById('conversion-hint');
            if (!hintEl) return;
            if (val > 0) {
                const target = state.inputCurrency === 'JPY' ? `NT$ ${Math.round(val * state.exchangeRate)}` : `Â¥ ${Math.round(val / state.exchangeRate)}`;
                hintEl.innerHTML = `<i data-lucide="alert-circle" size="10"></i> ç´„ ${target}`;
                hintEl.classList.remove('hidden');
                lucide.createIcons();
            } else hintEl.classList.add('hidden');
        }

        function changeDashboardMonth(val) { state.dashboardMonth = val; saveData(); renderDashboard(); updateChart(); }
        function changeHistoryDate(type, val) { if (type === 'day') state.historyDay = val; if (type === 'month') state.historyMonth = val; if (type === 'year') state.historyYear = val; saveData(); renderHistory(); }
        function setFilter(f) { state.historyFilter = f; document.querySelectorAll('#history-filter button').forEach(b => b.className = `px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${b.id.includes(f) ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`); renderHistory(); }
        function setSelection(type, id) { if (type === 'cat') { if (state.inputType === 'expense') state.selectedCategory = id; else state.selectedIncomeCategory = id; } else state.selectedPayment = id; renderAddForm(); }

        function saveTransaction(event) {
            event.preventDefault();
            const amt = parseFloat(document.getElementById('input-amount')?.value || 0);
            if (amt <= 0) return;
            const jpy = state.inputCurrency === 'JPY' ? amt : amt / state.exchangeRate;
            const twd = state.inputCurrency === 'TWD' ? amt : amt * state.exchangeRate;
            const cat = state.inputType === 'expense' ? state.selectedCategory : state.selectedIncomeCategory;
            state.transactions.unshift({ id: Date.now().toString(), type: state.inputType, amount: Math.round(jpy), twd: parseFloat(twd.toFixed(1)), category: cat, payment: state.selectedPayment, date: document.getElementById('input-date').value, note: document.getElementById('input-note').value });
            saveData();
            const btn = document.getElementById('save-btn');
            if(btn) {
                const oldText = btn.innerHTML;
                btn.classList.add('bg-emerald-600');
                btn.innerText = 'å„²å­˜æˆåŠŸï¼';
                setTimeout(() => { switchTab('history'); btn.classList.remove('bg-emerald-600'); btn.innerHTML = oldText; document.getElementById('input-amount').value = ''; document.getElementById('input-note').value = ''; lucide.createIcons(); }, 600);
            }
        }

        function deleteRecord(id) { if (confirm('åˆªé™¤äº¤æ˜“ï¼Ÿ')) { state.transactions = state.transactions.filter(t => t.id !== id); saveData(); renderAll(); updateChart(); } }

        function saveInitialCost(e) {
            e.preventDefault();
            const n = document.getElementById('init-input-name').value;
            const b = parseFloat(document.getElementById('init-input-budget').value) || 0;
            const a = parseFloat(document.getElementById('init-input-actual').value) || 0;
            const note = document.getElementById('init-input-note').value;
            if (!n) return;
            state.initialCosts.unshift({ id: Date.now().toString(), name: n, budget: b, actual: a, note: note });
            saveData();
            document.getElementById('init-input-name').value = '';
            document.getElementById('init-input-budget').value = '';
            document.getElementById('init-input-actual').value = '';
            document.getElementById('init-input-note').value = '';
            renderInitialCosts();
            renderDashboard();
        }

        function deleteInitial(id) { if (confirm('ç§»é™¤é …ç›®ï¼Ÿ')) { state.initialCosts = state.initialCosts.filter(i => i.id !== id); saveData(); renderInitialCosts(); renderDashboard(); } }
        function toggleSettings(show) { const el = document.getElementById('modal-settings'); if (el) el.classList.toggle('hidden', !show); if (show) renderSettings(); }

        function renderSettings() {
            const renderList = (id, list, type) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = list.map(item => `<div class="bg-slate-50 p-2.5 px-4 rounded-xl flex justify-between items-center mb-1.5 shadow-inner border border-slate-100"><div class="flex items-center gap-2"><i data-lucide="${ICON_OPTIONS[item.icon].icon}" size="12" style="color: ${ICON_OPTIONS[item.icon].color}"></i><span class="text-[10px] font-black text-slate-700">${item.name}</span></div><div class="flex items-center gap-2"><button onclick="openEditModal('${type}', '${item.id}')"><i data-lucide="edit-3" size="12" class="text-slate-400"></i></button><button onclick="deleteItem('${type}', '${item.id}')"><i data-lucide="trash-2" size="12" class="text-slate-400"></i></button></div></div>`).join('');
            };
            renderList('settings-cat-list', state.categories, 'cat');
            renderList('settings-inc-list', state.incomeCategories, 'inc');
            renderList('settings-pay-list', state.paymentMethods, 'pay');
            lucide.createIcons();
        }

        function openEditModal(type, id) {
            const lists = { 'cat': state.categories, 'inc': state.incomeCategories, 'pay': state.paymentMethods };
            const item = lists[type].find(i => i.id === id); if (!item) return;
            state.editingItem = { type, id, tempIcon: item.icon };
            const editName = document.getElementById('edit-name');
            if (editName) editName.value = item.name;
            const iconGrid = document.getElementById('edit-icon-grid');
            if (iconGrid) iconGrid.innerHTML = Object.keys(ICON_OPTIONS).map(k => `<button type="button" onclick="setEditIcon('${k}')" class="p-2.5 rounded-xl transition-all ${state.editingItem.tempIcon===k?'bg-blue-50 ring-2 ring-blue-500':'opacity-50 grayscale hover:opacity-100'}"><i data-lucide="${ICON_OPTIONS[k].icon}" style="color: ${ICON_OPTIONS[k].color}" size="20"></i></button>`).join('');
            const modal = document.getElementById('modal-edit');
            if (modal) modal.classList.remove('hidden');
            lucide.createIcons();
        }
        function setEditIcon(k) { state.editingItem.tempIcon = k; openEditModal(state.editingItem.type, state.editingItem.id); }
        function saveItemEdit() {
            const { type, id, tempIcon } = state.editingItem;
            const editName = document.getElementById('edit-name');
            const n = editName ? editName.value.trim() : ""; if (!n) return;
            const lists = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' };
            state[lists[type]] = state[lists[type]].map(i => i.id === id ? { ...i, name: n, icon: tempIcon } : i);
            saveData(); closeEditModal(); renderSettings(); renderAll();
        }
        function closeEditModal() { const modal = document.getElementById('modal-edit'); if (modal) modal.classList.add('hidden'); }
        function addItem(type) {
            const id = type + Date.now();
            const lists = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' };
            state[lists[type]].push({ id, name: 'æ–°é …ç›®', icon: 'ShoppingBag' });
            saveData(); openEditModal(type, id);
        }
        function deleteItem(type, id) { if (confirm('ç§»é™¤åˆ†é¡ï¼Ÿ')) { const lists = { 'cat': 'categories', 'inc': 'incomeCategories', 'pay': 'paymentMethods' }; state[lists[type]] = state[lists[type]].filter(i => i.id !== id); saveData(); renderSettings(); renderAll(); } }
        function resetApp() { if (confirm('é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.removeItem('jp_v17_data'); window.location.reload(); } }

        function init() {
            loadData();
            switchTab(state.activeTab);
            setInputCurrency(state.inputCurrency);
            setInputType(state.inputType);
            const dateInput = document.getElementById('input-date');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            const dashMonthInput = document.getElementById('dash-month-input');
            if (dashMonthInput) dashMonthInput.value = state.dashboardMonth;
            const rateInput = document.getElementById('set-rate');
            if (rateInput) {
                rateInput.value = state.exchangeRate;
                rateInput.oninput = (e) => { state.exchangeRate = parseFloat(e.target.value) || 0; saveData(); renderDashboard(); };
            }
            const amountInput = document.getElementById('input-amount');
            if (amountInput) amountInput.oninput = renderConversionHint;
            renderAll();
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
